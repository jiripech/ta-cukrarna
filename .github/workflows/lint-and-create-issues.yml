name: Lint and Create Issues for TS files

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  issues: write

jobs:
  lint-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run TypeScript linter
        id: lint
        continue-on-error: true
        run: |
          npm run lint -- --format json > lint-results.json || true
          
      - name: Parse lint results and create issues
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let lintResults;
            try {
              lintResults = JSON.parse(fs.readFileSync('lint-results.json', 'utf8'));
            } catch (error) {
              console.log('No lint results found or invalid JSON');
              return;
            }
            
            // Filter for warnings and errors
            const issues = lintResults.filter(result => 
              result.messages && result.messages.length > 0
            );
            
            if (issues.length === 0) {
              console.log('No linting issues found!');
              return;
            }
            
            // Group issues by file
            for (const fileResult of issues) {
              const warnings = fileResult.messages.filter(m => m.severity >= 1);
              
              if (warnings.length === 0) continue;
              
              const fileName = fileResult.filePath.replace(process.env.GITHUB_WORKSPACE + '/', '');
              const commitSha = context.sha.substring(0, 7);
              
              // Create issue body
              let issueBody = `## Linting warnings found in \`${fileName}\`\n\n`;
              issueBody += `**Commit:** ${commitSha}\n`;
              issueBody += `**Branch:** ${context.ref.replace('refs/heads/', '')}\n\n`;
              issueBody += `### Warnings:\n\n`;
              
              warnings.forEach((warning, index) => {
                const severity = warning.severity === 2 ? 'ðŸ”´ Error' : 'âš ï¸ Warning';
                issueBody += `${index + 1}. **${severity}** (Line ${warning.line}:${warning.column})\n`;
                issueBody += `   - **Rule:** \`${warning.ruleId}\`\n`;
                issueBody += `   - **Message:** ${warning.message}\n\n`;
              });
              
              // Check if issue already exists
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'linting,automated'
              });
              
              const issueTitle = `[Linting] ${fileName} - ${warnings.length} warning(s)`;
              const duplicate = existingIssues.data.find(issue => 
                issue.title === issueTitle
              );
              
              if (duplicate) {
                // Update existing issue with new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: duplicate.number,
                  body: `Still present in commit ${commitSha}\n\n${issueBody}`
                });
                console.log(`Updated existing issue #${duplicate.number}`);
              } else {
                // Create new issue
                const newIssue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: issueBody,
                  labels: ['linting', 'automated', 'bug']
                });
                console.log(`Created issue #${newIssue.data.number}`);
              }
            }

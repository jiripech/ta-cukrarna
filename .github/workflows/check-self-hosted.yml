name: 'Check self-hosted runner (manual test)'

on:
  workflow_dispatch:
    inputs:
      label:
        description: 'Runner label to probe (optional â€” if omitted the workflow will use PREF_RUNNER from repository variables/secrets)'
        required: false

permissions:
  actions: read

jobs:
  probe:
    runs-on: ubuntu-latest
    outputs:
      available: ${{ steps.check.outputs.available }}
      count: ${{ steps.check.outputs.count }}

    steps:
      - name: Check for self-hosted runner (Octokit)
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            const inputLabel = process.env.INPUT_LABEL || '';
            const defaultLabel = process.env.PREF || '';
            const label = inputLabel || defaultLabel;

            if (!label) {
              core.info('No label provided and PREF_RUNNER not set; skipping self-hosted probe');
              core.setOutput('count', '0');
              core.setOutput('available', 'false');
              return;
            }

            core.info(`Probing for self-hosted runners with label: ${label}`);
            const res = await github.rest.actions.listSelfHostedRunnersForRepo({ owner: context.repo.owner, repo: context.repo.repo });
            const runners = (res.data.runners || []).filter(r => r.status === 'online' && r.busy === false && r.labels.some(l => l.name === label));
            core.setOutput('count', String(runners.length));
            core.setOutput('available', runners.length > 0 ? 'true' : 'false');
        env:
          INPUT_LABEL: ${{ github.event.inputs.label }}
          PREF: ${{ vars.PREF_RUNNER || secrets.PREF_RUNNER }}

      - name: Show result
        run: |
          echo "Available: ${{ steps.check.outputs.available }}"
          echo "Count: ${{ steps.check.outputs.count }}"

      - name: Example gh CLI (optional)
        run: |
          if command -v gh >/dev/null 2>&1; then
            echo "gh is installed; listing runners via gh api (org-level or repo-level)"
            gh api repos/${{ github.repository }}/actions/runners --jq '.runners[] | {id: .id, name: .name, status: .status, busy: .busy, labels: .labels}' || true
          else
            echo "gh not available in runner (optional step)"
          fi
